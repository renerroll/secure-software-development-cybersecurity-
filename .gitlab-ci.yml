# .gitlab-ci.yml
# CI/CD pipeline for the lab project â€” includes security scanning templates

stages:
  - secret-scan
  - sast
  - test
  - build
  - sca
  - deploy
  - dast

# Include GitLab security templates
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/DAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml

# =========================================================================
# Secret detection (repo secret scanning)
# =========================================================================
secret_detection:
  stage: secret-scan
  needs: []
  allow_failure: false

# =========================================================================
# SAST (Static Application Security Testing)
# =========================================================================
sast:
  stage: sast
  needs: []
  allow_failure: false

# =========================================================================
# Unit tests
# =========================================================================
unit_test_job:
  stage: test
  image: python:3.11-slim
  allow_failure: false
  script:
    - cd lab
    - echo "Running unit tests..."
    - pip install -r requirements.txt
    - pip install pytest
    - pytest test_app.py
  needs:
    - job: sast
      optional: true

# =========================================================================
# Build (Docker image)
# =========================================================================
docker_build_job:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - echo "Building Docker image..."
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE" .
    - docker push "$CI_REGISTRY_IMAGE"
  needs: ["unit_test_job"]

# =========================================================================
# SCA / SBOM / container scanning
# =========================================================================
dependency_scanning:
  stage: sca
  allow_failure: false
  needs: ["docker_build_job"]

container_scanning:
  stage: sca
  allow_failure: false
  variables:
    CS_IMAGE: $CI_REGISTRY_IMAGE
  needs:
    - docker_build_job
  services:
    - docker:20.10.16-dind

# =========================================================================
# Deploy (used by DAST)
# =========================================================================
deploy_job:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  script:
    - echo "Deploying the application..."
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker pull "$CI_REGISTRY_IMAGE"
    - docker run -d --name my-python-app -p 5000:5000 "$CI_REGISTRY_IMAGE"
    - echo "Application deployed locally at http://my-python-app:5000"
    - sleep 10
  needs: ["container_scanning"]

# =========================================================================
# DAST (Dynamic Application Security Testing)
# =========================================================================
dast:
  stage: dast
  variables:
    DAST_WEBSITE: http://my-python-app:5000
  needs: ["deploy_job"]
  services:
    - docker:20.10.16-dind

